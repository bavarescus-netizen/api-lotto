<body style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #0f172a; color: white; padding:20px">

<div style="max-width: 900px; margin: auto;">
    <h2 style="color: #38bdf8; text-align: center;">ðŸ“Š Terminal de Inteligencia V4</h2>
    
    <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
        <button onclick="entrenar()" style="background: #1e293b; color: white; border: 1px solid #38bdf8; padding: 10px 20px; border-radius: 8px; cursor: pointer;">ðŸ§  Re-Entrenar Cerebro</button>
        <button onclick="prediccion()" style="background: #38bdf8; color: #0f172a; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">ðŸŽ¯ Obtener PredicciÃ³n</button>
    </div>

    <div id="decision-box" style="background: #1e293b; padding: 20px; border-radius: 12px; border-left: 5px solid #38bdf8; margin-bottom: 20px; text-align: center;">
        <h3 id="label-decision" style="margin: 0; color: #94a3b8; font-size: 0.9em;">ESTADO DEL MERCADO</h3>
        <div id="valor-decision" style="font-size: 1.8em; font-weight: bold; margin: 10px 0;">Esperando Comando...</div>
        <div id="top3-lista" style="color: #38bdf8; letter-spacing: 2px; font-size: 1.2em;"></div>
    </div>

    <div style="background: white; border-radius: 12px; padding: 15px;">
        <h3 style="color: #0f172a; margin-top: 0;">ðŸ“ˆ PrecisiÃ³n por Franja Horaria</h3>
        <canvas id="chart"></canvas>
    </div>

    <pre id="out" style="background: #000; color: #0f0; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 12px; overflow-x: auto; max-height: 150px;"></pre>
</div>

<script>
async function prediccion(){
    const out = document.getElementById("out");
    const divVal = document.getElementById("valor-decision");
    const divTop = document.getElementById("top3-lista");
    
    divVal.innerText = "Consultando 29,000 registros...";
    
    let r = await fetch("/prediccion");
    let j = await r.json();
    
    // Mostramos el JSON tÃ©cnico abajo
    out.innerText = JSON.stringify(j, null, 2);

    // LÃ“GICA VISUAL V4
    if(j.decision) {
        divVal.innerText = j.decision;
        divVal.style.color = j.decision.includes("JUGAR") ? "#4ade80" : "#fbbf24";
        // Mostramos el Top 3 de forma elegante
        divTop.innerText = "RECOMENDADOS: " + j.top3.map(a => a.animal).join(" - ");
    }
}

async function entrenar(){
    document.getElementById("out").innerText = "Iniciando aprendizaje profundo...";
    let r = await fetch("/entrenar/");
    let j = await r.json();
    document.getElementById("out").innerText = "Â¡Cerebro Actualizado!\n" + JSON.stringify(j, null, 2);
    cargarStats(); // Recargamos grÃ¡fico
}

async function cargarStats(){
    let r = await fetch("/stats");
    let data = await r.json();

    let horas = [];
    let precision = [];

    // Ordenar horas para que el grÃ¡fico sea coherente (9AM a 7PM)
    for (let h in data.hora_stats){
        horas.push(h);
        precision.push(data.hora_stats[h].precision);
    }

    // Si ya existe un chart, lo destruimos para actualizar
    if(window.myChart) window.myChart.destroy();

    window.myChart = new Chart(document.getElementById("chart"), {
        type: 'bar',
        data: {
            labels: horas,
            datasets: [{
                label: 'Fuerza del PatrÃ³n (%)',
                data: precision,
                backgroundColor: '#38bdf8'
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true, max: 1 } }
        }
    });
}

cargarStats();
</script>
</body>
